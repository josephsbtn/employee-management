<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aventra - Annual Request Manager</title>
    <script type="text/javascript" src="https://cdn.webix.com/edge/webix.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.webix.com/edge/webix.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='style/main.css') }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />
    <script src="../../static/js/sideNavbar.js"></script>
    <script src="../../static/js/annual-employee.js"></script>

    <style>
      .gradient-btn {
        background-image: linear-gradient(to right, var(--arunika-gold), var(--sunrise-red));  
      }
      
      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 40;
        transition: opacity 0.3s ease;
      }
      
      .sidebar-overlay.active {
        display: block;
        opacity: 1;
      }
      
      @media (max-width: 768px) {
        #sidebar-container {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          z-index: 50;
        }
        
        #sidebar-container.active {
          transform: translateX(0);
        }
        
        .main-content {
          margin-left: 0 !important;
        }
      }
      
      .hamburger-line {
        transition: all 0.3s ease;
      }
      
      .hamburger.active .line1 {
        transform: rotate(-45deg) translate(-5px, 6px);
      }
      
      .hamburger.active .line2 {
        opacity: 0;
      }
      
      .hamburger.active .line3 {
        transform: rotate(45deg) translate(-5px, -6px);
      }
    </style>
  </head>

  <body class="flex h-screen overflow-hidden">
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <aside
      class="w-64 bg-[var(--pure-white)] border-r border-[var(--warm-gray)] flex flex-col fixed h-full shadow-sm"
      id="sidebar-container"
    ></aside>

    <div class="flex-1 flex flex-col overflow-hidden main-content md:ml-64">
      <header
        class="bg-[var(--card-bg)] shadow-sm p-4 flex justify-between items-center border-b border-[var(--warm-gray)]"
      >
        <button
          class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors"
          id="hamburgerBtn"
        >
          <div class="hamburger w-6 h-5 flex flex-col justify-between">
            <span class="hamburger-line line1 w-full h-0.5 bg-gray-700 rounded"></span>
            <span class="hamburger-line line2 w-full h-0.5 bg-gray-700 rounded"></span>
            <span class="hamburger-line line3 w-full h-0.5 bg-gray-700 rounded"></span>
          </div>
        </button>

        <div class="flex-1" id="top-nav"></div>
      </header>

      <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-[var(--bg-light)]">
        <div id="content" style="height: 100%;"></div>
        <div id="detailRequest" class="hidden w-full bg-black bg-opacity-50 fixed inset-0 flex items-center justify-center absolute z-50"></div>
      </main>
    </div>

    <script>

      const fetchListRequest = async () => {
        try {
          const res = await axios.get("/api/annualRequest/list-manager");
          const requests = res.data.data || [];
          console.log("requests", requests);
          const sorting = requests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          $$("requestTable").clearAll();
          $$("requestTable").parse(sorting);

          console.log("‚úÖ Annual Leave Requests fetched:", requests);
        } catch (error) {
          console.error("‚ùå Failed to fetch annual leave requests:", error);
          webix.message({ type: "error", text: "Failed to fetch annual leave requests." });
        }
      };

      const applyFilters = () => {
        const statusFilter = $$("statusFilter").getValue();
        const typeFilter = $$("typeFilter").getValue();

        $$("requestTable").filter(function (obj) {
          const matchStatus = statusFilter === "all" || obj.status === statusFilter;
          const matchType = typeFilter === "all" || obj.type === typeFilter;
          return matchStatus && matchType;
        });
      };


      document.addEventListener("DOMContentLoaded", async () => {
        topNav();
        navbarSide(pagesManager);
        
        webix.ui({
          container: "content",
          rows: [
            {
              view: "toolbar",
              height: 50,
              cols: [
                { view: "label", label: "üìã Leave Requests Management" },
                {},
                {
                  view: "segmented",
                  id: "statusFilter",
                  width: 400,
                  value: "all",
                  options: [
                    { id: "all", value: "All" },
                    { id: "pending", value: "Pending" },
                    { id: "approved", value: "Approved" },
                    { id: "rejected", value: "Rejected" },
                    { id: "canceled", value: "Canceled" }
                  ],
                  on: {
                    onChange: function(newVal) {
                      applyFilters();
                    }
                  }
                }
              ]
            },
            {view: "toolbar",
              height: 60,
              padding: 10,
              cols: [
                {
                  view: "text",
                  id: "searchInput",
                  placeholder: "üîç Search by name ",
                  width: 300,
                  on: {
                    onTimedKeyPress: function () {
                      const value = this.getValue().toLowerCase();
                      $$("requestTable").filter(function (obj) {
                        const name = (obj.employee.name || "").toLowerCase();
                        return name.indexOf(value) !== -1;
                      });
                    },
                  },
                },{
                  view: "segmented",
                  id: "typeFilter",
                  width: 400,
                  value: "all",
                  options: [
                    { id: "all", value: "All" },
                    { id: "annual", value: "Annual" },
                    { id: "sick", value: "Sick" },
                    { id: "permission", value: "Permission" },
                  ],
                  on: {
                    onChange: function(newVal) {
                      applyFilters();
                    }
                  }
                }
              ],
            },
            {
              view: "datatable",
              id: "requestTable",
              autoConfig: true,
              autoheight: true,
              columns: [
                { 
                  id: "employee.name", 
                  header: [
                    { text: "Employee", css: "text-center" },
                  ], 
                  fillspace: true, 
                  css: "text-center text-sm",
                  template: (obj) => obj.employee ? obj.employee.name : "N/A"
                },
                { 
                  id: "type", 
                  header: [
                    { text: "Type", css: "text-center" },
                  ], 
                  fillspace: true, 
                  css: "text-center text-sm",
                  template: (obj) => {
                    const formatted = obj.type.charAt(0).toUpperCase() + obj.type.slice(1);
                    const typeClass =
                      obj.type === "annual"
                        ? "bg-blue-100 text-blue-700"
                        : obj.type === "sick"
                        ? "bg-orange-100 text-orange-700"
                        : obj.type === "permission"
                        ? "bg-sky-100 text-sky-700"
                        : "bg-gray-200 text-gray-700";
                    return `<span class="${typeClass} px-2 py-1 rounded text-xs font-medium">${formatted}</span>`;
                  }
                },
                { 
                  id: "startDate", 
                  header: [{ text: "From", css: "text-center" }], 
                  fillspace: true, 
                  css: "text-center text-sm",
                  template: (obj) => new Date(obj.startDate).toLocaleDateString("id-ID")  
                },
                { 
                  id: "endDate", 
                  header: [{ text: "To", css: "text-center" }], 
                  fillspace: true, 
                  css: "text-center text-sm",
                  template: (obj) => new Date(obj.endDate).toLocaleDateString("id-ID")
                },
                { 
                  id: "days", 
                  header: [{ text: "Days", css: "text-center" }], 
                  width: 80,
                  css: "text-center text-sm" 
                },
                { 
                  id: "status", 
                  header: [{ text: "Status", css: "text-center" }], 
                  fillspace: true, 
                  css: "text-center text-sm",
                  template: function (obj) {
                    if (obj.status === "pending") {
                      return `<span class="text-semibold text-white bg-yellow-500 px-2 py-1 rounded-lg text-xs">${obj.status}</span>`;
                    } else if (obj.status === "approved") {
                      return `<span class="text-semibold text-white bg-green-500 px-2 py-1 rounded-lg text-xs">${obj.status}</span>`;
                    } else if (obj.status === "rejected") {
                      return `<span class="text-semibold text-white bg-red-500 px-2 py-1 rounded-lg text-xs">${obj.status}</span>`;
                    } else {
                      return `<span class="text-semibold text-white bg-gray-500 px-2 py-1 rounded-lg text-xs">${obj.status}</span>`;
                    }
                  }
                },
                { 
                  id: "actions", 
                  header: [{ text: "Actions", css: "text-center" }], 
                  fillspace: true, 
                  css: "text-center text-sm",
                  template: function (obj) {
                    return `
                      <div class="flex justify-center items-center gap-3 h-full">
                        <button data-id="${obj._id}" class="detailsBtn px-3 py-1.5 rounded-lg text-sm font-medium text-white bg-[var(--calm-blue)] hover:bg-blue-600 transition duration-150">
                          üóíÔ∏è View Details
                        </button>
                      </div>
                    `;
                  }
                }
              ],
              onClick: {
                detailsBtn: function(e, id) {
                  const item = this.getItem(id);
                  renderDetailManager(item._id);
                }
              }
            }
          ]
        });
        
        await fetchListRequest();
      });
    </script>
  </body>
</html>